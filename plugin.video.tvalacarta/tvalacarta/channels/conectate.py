# -*- coding: utf-8 -*-#------------------------------------------------------------# pelisalacarta - XBMC Plugin# Canal para http://www.conectate.gov.ar# creado por rsantaella# http://blog.tvalacarta.info/plugin-xbmc/pelisalacarta/#------------------------------------------------------------import urlparse,urllib2,urllib,reimport os, sysfrom core import loggerfrom core import configfrom core import scrapertoolsfrom core.item import Itemfrom servers import servertools__channel__ = "conectate"__category__ = "F"__type__ = "generic"__title__ = "conectate"__language__ = "ES"__creationdate__ = "20121130"__vfanart__ = "http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/bgBody.gif"DEBUG = config.get_setting("debug")def isGeneric():    return Truedef mainlist(item):    logger.info("tvalacarta.channels.conectate mainlist")       itemlist = []    itemlist.append( Item(channel=__channel__, title="Encuentro", action="encuentro", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=1&canalId=1&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_encuentro.png", viewmode="movie", fanart = __vfanart__))     itemlist.append( Item(channel=__channel__, title="Pakapaka", action="pakapaka", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=2&canalId=2&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))     itemlist.append( Item(channel=__channel__, title="Ronda", action="ronda", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=3&canalId=3&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))    itemlist.append( Item(channel=__channel__, title="Educ.ar", action="educar", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=125&canalId=125&tipoEmisionId=2", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_educar.png", fanart = __vfanart__))    itemlist.append( Item(channel=__channel__, title="Conectar igualdad", action="conectar", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=126&canalId=126&tipoEmisionId=2", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_conectarigualdad.png", fanart = __vfanart__))    return itemlistdef encuentro(item):    logger.info("tvalacarta.channels.conectate encuentro")    itemlist = []    itemlist.append( Item(channel=__channel__, title="Películas", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=1&canalId=1&tipoEmisionId=1", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_encuentro.png", fanart = __vfanart__))     itemlist.append( Item(channel=__channel__, title="Especiales", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=1&canalId=1&tipoEmisionId=2", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_encuentro.png", fanart = __vfanart__))     itemlist.append( Item(channel=__channel__, title="Series", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=1&canalId=1&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_encuentro.png", fanart = __vfanart__))    itemlist.append( Item(channel=__channel__, title="Micros", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=1&canalId=1&tipoEmisionId=4", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_encuentro.png", fanart = __vfanart__))    return itemlistdef pakapaka(item):    logger.info("tvalacarta.channels.conectate pakapaka")    itemlist = []    itemlist.append( Item(channel=__channel__, title="Series", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=2&canalId=2&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))    itemlist.append( Item(channel=__channel__, title="Micros", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=2&canalId=2&tipoEmisionId=4", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))	    return itemlist	def ronda(item):    logger.info("tvalacarta.channels.conectate ronda")    itemlist = []    itemlist.append( Item(channel=__channel__, title="Series", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=3&canalId=3&tipoEmisionId=3", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))    itemlist.append( Item(channel=__channel__, title="Micros", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=3&canalId=3&tipoEmisionId=4", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_pakapaka.png", fanart = __vfanart__))    return itemlist	def educar(item):    logger.info("tvalacarta.channels.conectate educar")	    itemlist = []    itemlist.append( Item(channel=__channel__, title="Especiales", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=125&canalId=125&tipoEmisionId=2", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_educar.png", fanart = __vfanart__)) 	    return itemlist	def conectar(item):    logger.info("tvalacarta.channels.conectate conectar")    itemlist = []    itemlist.append( Item(channel=__channel__, title="Especiales", action="programas", url="http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?modulo=menu&temaCanalId=126&canalId=126&tipoEmisionId=2", thumbnail="http://www.conectate.gov.ar/educar-portal-video-web/module/decorator/img/footer_conectarigualdad.png", fanart = __vfanart__))     return itemlist	def programas(item):    logger.info("tvalacarta.channels.conectate programas")    # Descarga la pagina    headers = []    headers.append(["Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"])    headers.append(["Accept-Encoding","gzip,deflate"])    headers.append(["Accept-Language","es-ES,es;q=0.8,en;q=0.6"])    headers.append(["Connection","keep-alive"])    headers.append(["Host","www.conectate.gob.ar"])    headers.append(["Referer",item.url])    headers.append(["User-Agent","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.152 Safari/537.36"])    reintentos = 5    while reintentos>0:        data = scrapertools.cache_page(item.url,headers=headers,timeout=5)        if data!="":            break        logger.info("tvalacarta.channels.conectate.capitulos Respuesta vacia, reintentando")            reintentos = reintentos - 1    '''    <div class="resBusquedaEnGrilla">       <div class="popup" style="display:none">                        <div class="rateit1"  data-value="0" ></div>      <div class="resBusquedaEnGrilla_thumb">    <a href="/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do?canalId=2&modulo=menu&temaCanalId=2&tipoEmisionId=3&idRecurso=118889"><img src="http://conectate-api.educ.ar/repositorio/Imagen/ver?image_id=0cdae2cc-2dbf-4988-ba75-829bd222b5b2" alt="El asombroso mundo de Zamba" class="linkImg" /></a>                       </div>    <h1><a href="/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do?canalId=2&modulo=menu&temaCanalId=2&tipoEmisionId=3&idRecurso=118889">       El asombroso mundo de Zamba                          </a></h1>                           <p>Zamba, Niña, el Niño que lo Sabe Todo y la Maravillosa exploran distintas disciplinas y descubren curiosidades.Así, aprenden junto a los especialistas sobre música, arte, comidas, astronomía, el cuerpo humano, historia y paleontología. Además, clips musicales con Soledad Pastorutti, Kevin Johansen, La Mosca, Hilda Lizarazu y otros artistas.</p>    <div class="resBusquedaEnGrilla_descargas">    </div>    <div class="resBusquedaEnGrilla_btMas">    0 descargas                         </div>    </div>    <div class="resBusquedaEnGrilla_thumb">    <img src="http://conectate-api.educ.ar/repositorio/Imagen/ver?image_id=0cdae2cc-2dbf-4988-ba75-829bd222b5b2" alt="El asombroso mundo de Zamba" class="linkImg" />                           </div>    <h1><a href="/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do?canalId=2&modulo=menu&temaCanalId=2&tipoEmisionId=3&idRecurso=118889">    El asombroso mundo de Zamba                 </a></h1>                       </div>    '''    patron = '<div class="resBusquedaEnGrilla">(.*?)</a></h1[^<]+</div>'    matches = re.compile(patron,re.DOTALL).findall(data)    itemlist = []    for match in matches:        scrapedurl = scrapertools.find_single_match(match,'<a href="([^"]+)"')        scrapedthumbnail = scrapertools.find_single_match(match,'<img src="([^"]+)"')        scrapedtitle = scrapertools.find_single_match(match,'<h1><a[^>]+>([^<]+)</a>')        scrapedplot = scrapertools.find_single_match(match,'<p>([^<]+)</p>')        url = urlparse.urljoin(item.url,scrapedurl)        thumbnail = urlparse.urljoin(item.url,scrapedthumbnail)        title = unicode( scrapedtitle , "iso-8859-1" , errors="ignore").encode("utf-8")        title = scrapertools.htmlclean(title).strip()        plot = unicode( scrapedplot , "iso-8859-1" , errors="ignore").encode("utf-8")        plot = scrapertools.htmlclean(plot).strip()        if (item.title == "Películas") or (item.title == "Especiales"):            itemlist.append( Item(channel=__channel__, action="play", server="conectate", title=title , url=url , thumbnail=thumbnail , fanart=thumbnail,  plot=plot , viewmode="movie_with_plot", folder=False) )        else:            itemlist.append( Item(channel=__channel__, action="capitulos", title=title , url=url , thumbnail=thumbnail , fanart=thumbnail,  plot=plot , viewmode="movie_with_plot", folder=True) )    patron = '<a href="/educar-portal-video-web/module/busqueda/busquedaAvanzada.do?([^"]+)"> &gt;&gt; </a>'    matches = re.compile(patron,re.DOTALL).findall(data)    #if DEBUG: scrapertools.printMatches(matches)        for match in matches:        scrapedurl = "http://www.conectate.gov.ar/educar-portal-video-web/module/busqueda/busquedaAvanzada.do"+match		        scrapedtitle = ">> Página siguiente"        itemlist.append( Item(channel=__channel__, action="programas", title=scrapedtitle , url=scrapedurl ,  folder=True) )    return itemlist	def capitulos(item):    logger.info("tvalacarta.channels.conectate capitulos")        # Descarga la pagina    headers = []    headers.append(["Accept","text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"])    headers.append(["Accept-Encoding","gzip,deflate"])    headers.append(["Accept-Language","es-ES,es;q=0.8,en;q=0.6"])    headers.append(["Connection","keep-alive"])    headers.append(["Host","www.conectate.gob.ar"])    headers.append(["Referer",item.url])    headers.append(["User-Agent","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.152 Safari/537.36"])    reintentos = 5    while reintentos>0:        data = scrapertools.cachePage(item.url,headers=headers,timeout=5)        if data!="":            break        logger.info("tvalacarta.channels.conectate.capitulos Respuesta vacia, reintentando")            reintentos = reintentos - 1    data = data.decode('iso8859-1').encode('utf-8')    data = data.replace("\n", " ")    data = data.replace("\r", " ")    data = " ".join(data.split())	    #logger.info(data)    #patron = '</div> <a href="/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do?([^"]+)">([^"]+)</a>'    patron = '</div> <a href="/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do?([^"]+)">(.*?)</a>'    matches = re.compile(patron,re.DOTALL).findall(data)    if DEBUG: scrapertools.printMatches(matches)	    itemlist = []    for match in matches:        scrapedurl = "http://www.conectate.gov.ar/educar-portal-video-web/module/detalleRecurso/DetalleRecurso.do"+match[0]        scrapedtitle = scrapertools.htmlclean(match[1])		        itemlist.append( Item(channel=__channel__, action="play", server="conectate", title=scrapedtitle , url=scrapedurl ,  folder=False) )    return itemlist# Verificación automática de canales: Esta función debe devolver "True" si todo está ok en el canal.def test():    bien = True        # El canal tiene estructura programas -> episodios -> play    items = mainlist(Item())    items = encuentro(items[0])    items_programas = programas(items[0])    if len(items_programas)==0:        return False    return bien